chrome.runtime.onMessage.addListener((function(t,e,r){if("ping"!==t.action)return"transcribe"===t.action?(async function(){try{const t=function(t){const e=new URL(t);return new URLSearchParams(e.search).get("v")}(window.location.href);if(!t)throw new Error("Could not extract video ID from URL");const e=await async function(t){try{const e=await fetch(`https://www.youtube.com/watch?v=${t}`),r=(await e.text()).match(/ytInitialPlayerResponse\s*=\s*(\{.+?\})\s*;/);if(!r||!r[1])throw new Error("Could not find player response data");const n=JSON.parse(r[1]),o=[];return n.captions&&n.captions.playerCaptionsTracklistRenderer&&n.captions.playerCaptionsTracklistRenderer.captionTracks?n.captions.playerCaptionsTracklistRenderer.captionTracks:o}catch(t){return console.error("Error getting caption tracks:",t),[]}}(t);if(0===e.length)throw new Error("No caption tracks available for this video");let r=e.find((t=>"en"===t.language_code))||e[0];const n=function(t){const e=[],r=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("text");for(let t=0;t<r.length;t++){const n=r[t],o=parseFloat(n.getAttribute("start")),a=parseFloat(n.getAttribute("dur")||"0"),c=n.textContent.trim();c&&e.push({start:o,end:o+a,text:c})}return e}(await async function(t){try{const e=await fetch(t);return await e.text()}catch(t){throw console.error("Error getting caption content:",t),t}}(r.baseUrl));let o=n.map((t=>t.text)).join(" ");return chrome.runtime.sendMessage({action:"trackEvent",eventType:"transcriptFetch",eventData:{videoId:t}}),{transcript:o,segments:n}}catch(t){throw console.error("Error getting video transcript:",t),t}}().then((t=>{r({success:!0,transcript:t.transcript,segments:t.segments})})).catch((t=>{console.error("Transcription error:",t),r({success:!1,error:t.message||"Unknown error occurred"})})),!0):void("seek"===t.action&&(function(t){const e=document.querySelector("video");e&&(e.currentTime=t,e.play().catch((t=>{console.error("Error playing video:",t)})),chrome.runtime.sendMessage({action:"trackEvent",eventType:"timestampClick",eventData:{timestamp:t}}))}(t.timestamp),r({success:!0})));r({success:!0})})),chrome.runtime.sendMessage({action:"contentScriptLoaded"});